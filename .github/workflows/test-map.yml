name: Build Test Map
on:
  push:
    branches: [main]
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  build-map:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    defaults:
      run:
        shell: bash -el {0}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: mamba-org/setup-micromamba@v2.0.7
        with:
          environment-file: ./environment.yml
          init-shell: bash
          create-args: >-
            --verbose
            python=3.11
            matplotlib=3.9
          cache-environment: true
          cache-downloads: false

      - name: Build Ultraplot
        run: |
          pip install --no-build-isolation --no-deps .

      - name: Generate test coverage map
        run: |
          mkdir -p .ci
          pytest -n auto --cov=ultraplot --cov-branch --cov-context=test --cov-report= --cov-append ultraplot
          python tools/ci/build_test_map.py --coverage-file .coverage --output .ci/test-map.json --root .

      - name: Cache test map
        uses: actions/cache@v4
        with:
          path: .ci/test-map.json
          key: test-map-${{ github.sha }}
